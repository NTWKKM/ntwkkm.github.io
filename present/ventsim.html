<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced VentSim: Physiology Engine</title>
    <style>
        /* --- Styles (Dark Mode) --- */
        body { font-family: 'Segoe UI', 'Kanit', sans-serif; line-height: 1.6; color: #e0e0e0; margin: 0; padding: 20px; background-color: #1a1d21; }
        .container { max-width: 1000px; margin: auto; background: #2c313a; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h1 { color: #61afef; border-bottom: 3px solid #61afef; padding-bottom: 10px; text-align: center; }
        h3 { color: #98c379; margin-top: 25px; border-left: 5px solid #98c379; padding-left: 10px; }
        
        .sim-box { background: #21252b; border: 1px solid #3e4451; border-radius: 8px; padding: 20px; margin-top: 20px; }
        
        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .btn { background: #3e4451; color: #fff; border: 1px solid #5c6370; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #61afef; border-color: #61afef; color: #21252b; }
        .btn.active { background: #61afef; color: #21252b; font-weight: bold; box-shadow: 0 0 10px rgba(97, 175, 239, 0.4); }
        .btn-play { border-color: #e5c07b; color: #e5c07b; }
        .btn-play:hover { background: #e5c07b; color: #21252b; }

        /* Monitors */
        .monitor-panel { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .monitor-card { background: #181a1f; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .monitor-label { font-size: 0.75em; color: #abb2bf; display: block; margin-bottom: 5px; }
        .monitor-val { font-size: 1.4em; font-weight: bold; font-family: 'Consolas', monospace; }
        .text-blue { color: #61afef; } .text-green { color: #98c379; } .text-yellow { color: #e5c07b; } .text-red { color: #e06c75; }

        /* Canvas */
        canvas { background: #000; border: 1px solid #5c6370; width: 100%; display: block; border-radius: 4px; }

        /* Explanations */
        .phys-info { font-size: 0.9em; background: #333842; padding: 15px; border-radius: 6px; margin-top: 20px; color: #d1d5db; }
        .phys-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 5px; }
        .tag-res { background: #e06c75; color: #21252b; }
        .tag-comp { background: #98c379; color: #21252b; }
    </style>
</head>
<body>

<div class="container">
    <h1>Advanced Respiratory Physics Engine (Non-Linear)</h1>
    <p style="text-align: center; color: #abb2bf;">จำลองกลศาสตร์ปอดตามหลักสรีรวิทยา: Hysteresis, Turbulence, และ Volume-Dependent Resistance</p>

    <div class="sim-box">
        <div class="controls">
            <button class="btn btn-play" id="btn-toggle" onclick="toggleSim()">⏸ Pause</button>
            <div style="width: 1px; background: #555; height: 30px; margin: 0 10px;"></div>
            <button class="btn active" onclick="setPreset('NORMAL')">Normal Lung</button>
            <button class="btn" onclick="setPreset('ARDS')">ARDS (Stiff & Hysteresis)</button>
            <button class="btn" onclick="setPreset('COPD')">COPD (Dynamic Compression)</button>
            <button class="btn" onclick="setPreset('FIBROSIS')">Fibrosis (Restrictive)</button>
        </div>

        <div class="monitor-panel">
            <div class="monitor-card"><span class="monitor-label">Ppeak</span><span class="monitor-val text-yellow" id="val-ppeak">--</span></div>
            <div class="monitor-card"><span class="monitor-label">Vte (ml)</span><span class="monitor-val text-blue" id="val-vte">--</span></div>
            <div class="monitor-card"><span class="monitor-label">MV (L)</span><span class="monitor-val text-green" id="val-mv">--</span></div>
            <div class="monitor-card"><span class="monitor-label">C_dyn</span><span class="monitor-val text-blue" id="val-cdyn">--</span></div>
            <div class="monitor-card"><span class="monitor-label">R_aw (Dyn)</span><span class="monitor-val text-red" id="val-raw">--</span></div>
        </div>

        <canvas id="waveforms" height="320"></canvas>
        <div style="text-align: right; font-size: 0.8em; color: #777; margin-top: 5px;">*Showing 30s window</div>
    </div>

    <div class="phys-info" id="phys-desc">
        </div>
</div>

<script>
    // --- 1. ADVANCED CONFIGURATION ---
    const PRESETS = {
        'NORMAL': { 
            name: "Normal Physiological Lung",
            // Compliance Params
            cBase: 60,      // Basic Compliance (ml/cmH2O)
            hysteresis: 2,  // Pressure difference required for recruitment (cmH2O)
            vMax: 3.0,      // Capacity (L)
            
            // Resistance Params
            rBase: 5,       // Airway Resistance (cmH2O/L/s)
            rFlowFactor: 0.5, // Turbulence factor (Rohrer's K2)
            rVolDependence: 1.0, // How much R drops with Volume (1 = Normal)
            
            desc: "<b>Normal:</b> Resistance และ Compliance เปลี่ยนแปลงเล็กน้อยตามการหายใจ Hysteresis มีค่าต่ำ (Surfactant ทำงานปกติ)"
        },
        'ARDS': { 
            name: "Severe ARDS",
            cBase: 25,      // Very Stiff
            hysteresis: 8,  // High Hysteresis (Massive Recruitment/Derecruitment)
            vMax: 1.0,      // Baby Lung
            
            rBase: 8,       // Slightly higher R
            rFlowFactor: 0.5,
            rVolDependence: 0.5, 

            desc: "<b>ARDS:</b> <span class='tag-comp'>Low Compliance</span> ปอดแข็งมากต้องใช้แรงดันสูง <span class='tag-comp'>High Hysteresis</span> กราฟขาขึ้นและลงต่างกันมากจากการเปิด/ปิดของถุงลม (Recruitment)"
        },
        'COPD': { 
            name: "Severe COPD",
            cBase: 80,      // High Static Compliance (Emphysema)
            hysteresis: 3,  
            vMax: 3.5,      // Hyperinflated
            
            rBase: 15,      // High Base Resistance
            rFlowFactor: 2.5, // High Turbulence sensitivity
            rVolDependence: 4.0, // **Critical**: R increases massively at low volumes (Dynamic Compression)

            desc: "<b>COPD:</b> <span class='tag-res'>High Resistance</span> โดยเฉพาะช่วงหายใจออก (Dynamic Compression) ค่า R จะพุ่งสูงขึ้นเมื่อ Flow สูงหรือ Volume ต่ำ ทำให้เกิด Air Trapping"
        },
        'FIBROSIS': {
             name: "Pulmonary Fibrosis",
             cBase: 20,
             hysteresis: 3,
             vMax: 0.8, // Restrictive

             rBase: 6, // Traction airway dilation (R might be low-normal)
             rFlowFactor: 0.5,
             rVolDependence: 1.5,

             desc: "<b>Fibrosis:</b> <span class='tag-comp'>Restrictive</span> ปอดหดรัดตัว ปริมาตรจำกัด (Low Vmax) กราฟชันมากแต่นิ่มนวลกว่า ARDS เพราะ Hysteresis น้อยกว่า"
        }
    };

    const SETTINGS = {
        PEEP: 5,
        Pinsp: 15, // Pressure Control Level (Above PEEP)
        RR: 15,
        Ti: 1.0
    };

    // Simulation State
    let isRunning = true;
    let currentPreset = PRESETS['NORMAL'];
    let t = 0;
    let cycleT = 0;
    let phase = 'EXP';
    
    // Physics State
    let state = {
        paw: 5,     // Airway Pressure
        palv: 5,    // Alveolar Pressure
        vol: 0,     // Volume above FRC (L)
        flow: 0,    // Flow (L/s)
        
        // Monitoring variables
        lastRaw: 0,
        lastComp: 0
    };

    // Data History
    const MAX_POINTS = 1800; // 30s @ 60fps
    let history = { p: [], f: [], v: [] };

    // --- 2. PHYSICS ENGINE (Logic Refined) ---
    function updatePhysics() {
        const dt = 0.0167; // 1/60 s
        t += dt;
        cycleT += dt;

        // 2.1 Cycle Logic (PCV Simulation)
        const cycleDur = 60 / SETTINGS.RR;
        if (phase === 'INS' && cycleT >= SETTINGS.Ti) {
            phase = 'EXP'; cycleT = 0;
        } else if (phase === 'EXP' && cycleT >= (cycleDur - SETTINGS.Ti)) {
            phase = 'INS'; cycleT = 0;
        }

        // 2.2 Ventilator Output (Target Paw)
        let targetPaw = SETTINGS.PEEP;
        if (phase === 'INS') targetPaw = SETTINGS.PEEP + SETTINGS.Pinsp;
        
        // Valve lag smoothing
        state.paw += (targetPaw - state.paw) * 0.2;

        // --- 2.3 ADVANCED LUNG MECHANICS ---

        // A. RESISTANCE (Non-Linear)
        // Formula: R = (Rbase + K_turb * |Flow|) * (V_ref / V_current)^k_vol
        // Logic: Resistance increases with Flow (Turbulence) AND increases as lung empties (Tethering loss)
        
        let volForRes = Math.max(0.1, state.vol + 0.5); // Avoid div by zero, assume FRC ~ 0.5 offset
        let volFactor = Math.pow(1.0 / volForRes, currentPreset.rVolDependence);
        let flowFactor = 1 + (currentPreset.rFlowFactor * Math.abs(state.flow));
        
        let currentR = currentPreset.rBase * flowFactor * volFactor;
        // Clamp R to realistic bounds (e.g., COPD dynamic compression limit)
        currentR = Math.min(currentR, 200); 

        // B. COMPLIANCE & ELASTIC RECOIL (Non-Linear + Hysteresis)
        // Logic: Sigmoidal Curve + Hysteresis Offset
        
        // 1. Base Elastic Pressure (Sigmoid: P = -ln(Vmax/V - 1) / k)
        // Simplified Sigmoid approximation for Alveolar Pressure:
        // Palv_elastic = V / C_base + Overdistension_Penalty
        
        let relativeVol = state.vol / currentPreset.vMax;
        if(relativeVol > 0.95) relativeVol = 0.95; // Limit
        
        // Overdistension term (exponential rise near Vmax)
        let overdistension = Math.pow(relativeVol, 4) * 20; 
        
        // Hysteresis: Inspiration requires EXTRA pressure (Recruitment force)
        // Expiration requires LESS pressure (Stress relaxation)
        let hysteresisForce = 0;
        if (state.flow > 0) { // Insp
            hysteresisForce = currentPreset.hysteresis * (1 - relativeVol); // High at start, low at end
        } else { // Exp
            hysteresisForce = -currentPreset.hysteresis * 0.2; // Slight relaxation
        }

        // Total Elastic Recoil Pressure
        let Pel = (state.vol * 1000 / currentPreset.cBase) + overdistension + hysteresisForce;

        // C. EQUATION OF MOTION
        // Flow = (Paw - Palv) / R
        // Palv = Pel + PEEP_offset (assumed base pressure)
        
        // Calculate Flow
        // Note: Palv in equation is the pressure *inside* the alveoli due to recoil + PEEP
        let drivingP = state.paw - Pel; 
        
        // Solve for Flow iteratively or directly?
        // Simple Euler: Flow = drivingP / currentR
        state.flow = drivingP / currentR;

        // Update Volume
        state.vol += state.flow * dt;
        if(state.vol < 0) state.vol = 0; // No negative volume below collapse

        // --- 2.4 DATA LOGGING ---
        // Store raw values for monitors
        state.lastRaw = currentR; 
        
        // Calculate Dynamic Compliance (approx for cycle)
        if (phase === 'INS' && Math.abs(state.flow) < 0.05) {
             // Near end inspiration
             let dP = state.paw - SETTINGS.PEEP;
             if(dP > 0) state.lastComp = (state.vol * 1000) / dP;
        }

        history.p.push(state.paw);
        history.f.push(state.flow * 60); // L/min
        history.v.push(state.vol * 1000); // ml

        if (history.p.length > MAX_POINTS) {
            history.p.shift(); history.f.shift(); history.v.shift();
        }

        // Update UI every 5 frames
        if (Math.floor(t * 60) % 10 === 0) updateMonitors(Pel);
    }

    function updateMonitors(Pel) {
        // Find Peak and Vte from recent history (last cycle approx)
        // Just showing instantaneous for demo smoothness
        document.getElementById('val-ppeak').innerText = Math.round(state.paw);
        document.getElementById('val-vte').innerText = Math.round(state.vol * 1000);
        document.getElementById('val-mv').innerText = ((state.vol * 1000 * SETTINGS.RR) / 1000).toFixed(1);
        
        document.getElementById('val-cdyn').innerText = state.lastComp > 0 ? Math.round(state.lastComp) : "--";
        document.getElementById('val-raw').innerText = Math.round(state.lastRaw);
    }

    // --- 3. RENDERING ---
    function draw() {
        if (isRunning) updatePhysics();
        
        const canvas = document.getElementById('waveforms');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height;

        ctx.clearRect(0, 0, w, h);
        
        // Grid
        ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
        ctx.beginPath(); 
        ctx.moveTo(0, h/3); ctx.lineTo(w, h/3); 
        ctx.moveTo(0, 2*h/3); ctx.lineTo(w, 2*h/3);
        ctx.stroke();

        // Draw Waves
        drawWave(ctx, history.p, 0, h/3, '#e5c07b', 0, 40, "Paw (cmH2O)");
        drawWave(ctx, history.f, h/3, h/3, '#98c379', -60, 60, "Flow (L/min)");
        drawWave(ctx, history.v, 2*h/3, h/3, '#61afef', 0, 800, "Volume (ml)");

        requestAnimationFrame(draw);
    }

    function drawWave(ctx, data, yOffset, h, color, min, max, label) {
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        
        // Auto scale logic or fixed? Use fixed for medical consistency
        const range = max - min;
        
        for (let i = 0; i < data.length; i++) {
            let x = (i / MAX_POINTS) * ctx.canvas.width;
            let val = data[i];
            let norm = (val - min) / range;
            let y = yOffset + h - (norm * h); // Invert Y
            if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Label
        ctx.fillStyle = color;
        ctx.font = "12px sans-serif";
        ctx.fillText(label, 5, yOffset + 15);
        
        // Min/Max Text
        ctx.textAlign = "right";
        ctx.fillText(max, ctx.canvas.width - 5, yOffset + 15);
        ctx.fillText(min, ctx.canvas.width - 5, yOffset + h - 5);
        ctx.textAlign = "left";
    }

    // --- 4. CONTROLS ---
    function setPreset(key) {
        currentPreset = PRESETS[key];
        document.querySelectorAll('.btn:not(.btn-play)').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('phys-desc').innerHTML = currentPreset.desc;
        
        // Reset State to avoid physics explosion
        state.vol = 0; state.flow = 0; state.paw = SETTINGS.PEEP;
        history = { p: [], f: [], v: [] };
    }

    function toggleSim() {
        isRunning = !isRunning;
        const btn = document.getElementById('btn-toggle');
        btn.innerText = isRunning ? "⏸ Pause" : "▶ Play";
    }

    // Init
    setPreset('NORMAL'); // Set initial desc
    draw();

</script>
</body>
</html>
