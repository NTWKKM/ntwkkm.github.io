<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MNRH CPR Recorder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujm9Xz2L6gXpQv1V3L9j9H7A5tA9oH/G0+E+D5hO5uE9zG2K3uKzK+Q8sV8T4W0N3G4R2e9G2g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Root Variables for Colors --- */
        :root {
            --primary-color: #2b6cb0; /* Deep Blue */
            --secondary-color: #38b2ac; /* Teal */
            --danger-color: #c53030; /* Red */
            --light-bg: #f9fafb; /* Light Gray Background */
            --medium-gray-border: #e5e7eb; /* Medium Gray for Borders */
            --dark-text: #2d3748; /* Dark Text */
            --light-text: #ffffff; /* Light Text for dark backgrounds */
            --form-bg: #edf2f7; /* Light Blue for form sections */
            --fieldset-border: #a0aec0; /* Gray for fieldset borders */
        }

        /* --- Base Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background: var(--light-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 25px;
            background: var(--light-text);
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            flex-grow: 1;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 700;
        }
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; }
        h3 { font-size: 1.4em; }

        /* --- Login View --- */
        #loginView {
            max-width: 400px;
            margin: 60px auto;
            text-align: center;
            padding: 30px;
        }
        .login-box {
            background-color: var(--light-text);
            border: 1px solid var(--medium-gray-border);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .login-box img {
            height: 100px;
            width: 100px;
            border-radius: 50%;
            margin-bottom: 25px;
            border: 3px solid var(--secondary-color);
        }
        .login-box h2 { font-size: 1.6em; }
        .login-box p {
            color: var(--dark-text);
            margin-bottom: 25px;
            font-size: 1em;
        }
        .login-box button {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 12px;
        }
        #googleSignInBtn {
            background-color: var(--light-text);
            color: var(--dark-text);
            border: 1px solid var(--medium-gray-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #googleSignInBtn:hover {
            background-color: #f0f4f8;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #googleSignInBtn img {
            height: 28px;
            width: 28px;
            border: none;
            margin-top: 0; /* Adjusted from original */
            margin-right: 4px;
            vertical-align: middle;
        }
        .login-box .divider {
            color: #b0b0b0;
            margin: 25px 0;
            position: relative;
        }
        .login-box .divider::before,
        .login-box .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: var(--medium-gray-border);
        }
        .login-box .divider::before { left: 0; }
        .login-box .divider::after { right: 0; }
        #emailPasswordForm input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--medium-gray-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        #emailPasswordForm input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.2);
        }

        /* --- Header & Navigation --- */
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--medium-gray-border);
            padding-bottom: 18px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-nav h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
        }
        .nav-link, .user-info button {
            font-size: 1em;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .nav-link:hover, .user-info button:hover {
            background-color: #e6f0fa;
            color: var(--primary-color);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .user-info span {
            font-weight: 600;
            color: var(--dark-text);
            font-size: 1.05em;
        }

        /* --- General Form & Button Styles --- */
        form label {
            display: block;
            margin: 12px 0 6px;
            font-weight: 600;
            color: var(--dark-text);
        }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--light-text);
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="time"]:focus, select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(56, 178, 172, 0.2);
        }
        fieldset {
            margin-bottom: 30px;
            border-radius: 12px;
            border: 1px solid var(--fieldset-border);
            background: var(--form-bg);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        legend {
            padding: 0 12px;
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.2em;
            background-color: var(--form-bg);
            border-radius: 5px;
            border: 1px solid var(--fieldset-border);
            margin-left: 10px;
        }
        button {
            cursor: pointer;
            font-size: 1em;
            border-radius: 8px;
            padding: 10px 18px;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            opacity: 0.9;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .primary { background-color: var(--primary-color); color: var(--light-text); }
        .primary:hover { background-color: #245a96; }
        .secondary { background-color: var(--secondary-color); color: var(--light-text); }
        .secondary:hover { background-color: #319e99; }
        .danger { background-color: var(--danger-color); color: var(--light-text); }
        .danger:hover { background-color: #a02424; }

        /* --- Time Input with 'Now' Button --- */
        .time-input-group {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .time-input-group label {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .time-input-group .use-now-btn {
             padding: 8px 15px;
             font-size: 0.9em;
             flex-shrink: 0;
        }

        /* --- Recorder View --- */
        #cyclesContainer {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed var(--medium-gray-border);
            background: var(--light-text);
            border-radius: 10px;
        }
        .cycle-block {
            border: 1px solid #d4dae0;
            margin-bottom: 20px;
            padding: 20px;
            background: #fdfefe;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        }
        .cycle-block h3 {
            margin: 0 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.3em;
            color: var(--primary-color);
        }
        .cycle-grid, .meds-grid, .blood-gas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px 20px;
            align-items: end;
        }
        .dtx-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .dtx-input-wrapper label {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .remove-btn {
            color: var(--danger-color);
            background: var(--light-text);
            border: 1px solid var(--danger-color);
            font-size: 0.85em;
            border-radius: 6px;
            padding: 4px 10px;
            box-shadow: none;
        }
        .remove-btn:hover {
            background-color: #ffebeb;
            box-shadow: none;
        }
        .meds-list, .investigation-list, .medList, .dtxList {
            margin: 15px 0;
            padding-left: 25px;
            list-style-type: disc;
            color: var(--dark-text);
        }
        .meds-list li, .investigation-list li, .medList li, .dtxList li { margin-bottom: 8px; }
        .add-btn {
            margin-top: 10px;
            margin-bottom: 15px;
            background: var(--secondary-color);
            color: var(--light-text);
            padding: 8px 15px;
            font-size: 0.9em;
        }
        .meds-form-container {
            display: flex;
            justify-content: space-between;
            gap: 25px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .meds-selection-group,
        .meds-details-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-width: 280px;
        }
        .meds-details-group input {
            width: 100%;
            box-sizing: border-box;
        }
        .meds-selection-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin: 0;
            cursor: pointer;
        }
        .meds-selection-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
        }
        details {
            margin-bottom: 20px;
            border: 1px solid var(--fieldset-border);
            border-radius: 12px;
            background: var(--form-bg);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.3s ease;
        }
        details:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        summary {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            outline: none;
            user-select: none;
            list-style: none;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        summary::-webkit-details-marker { display: none; }
        summary::before {
            font-family: "Font Awesome 6 Free";
            content: '\f054'; /* Right Arrow */
            font-weight: 900;
            font-size: 1em;
            color: var(--secondary-color);
            transition: transform 0.2s ease;
        }
        details[open] summary::before { content: '\f078'; /* Down Arrow */ }
        .investigation-content, .investigation-block { padding-top: 10px; }
        hr {
            border: 0;
            border-top: 1px solid var(--fieldset-border);
            margin: 15px 0;
        }

        /* --- NEW: Layout for Recorder View --- */
        .recorder-layout {
            display: flex;
            gap: 25px;
            align-items: flex-start;
        }
        #cprForm {
            flex: 1;
            min-width: 0; /* Prevents form from overflowing */
        }

        /* --- UPDATED: Sticky Summary Panel --- */
        #summaryPanel {
            position: sticky;
            top: 20px;
            flex: 0 0 320px;
            background-color: #ffffff;
            border: 1px solid var(--medium-gray-border);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            padding: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        #summaryPanel h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #summaryPanel p {
            margin: 0 0 12px;
            font-size: 0.95em;
            line-height: 1.4;
        }
        #summaryPanel strong {
            color: var(--dark-text);
            display: inline-block;
            width: 90px;
        }
        #summaryPanel .summary-section {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray-border);
            padding-bottom: 10px;
        }
        #summaryPanel .summary-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        #summaryPanel ul {
            padding-left: 15px;
            margin: 8px 0 0 0;
            font-size: 0.9em;
            list-style: none;
        }
        #summaryPanel ul li {
            margin-bottom: 5px;
            color: #4A5568;
            position: relative;
            padding-left: 15px;
        }
        #summaryPanel ul li::before {
            content: '\f0da';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 1px;
            color: var(--secondary-color);
        }

        /* --- Manage View --- */
        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .table-container {
            overflow-x: auto;
            background: var(--light-text);
            border-radius: 10px;
            border: 1px solid var(--medium-gray-border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        th, td {
            padding: 15px 18px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray-border);
        }
        thead th {
            background-color: #eef2f7;
            font-weight: 700;
            color: var(--dark-text);
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        tbody tr:hover { background-color: #f6faff; }
        .loading, .no-cases {
            text-align: center;
            padding: 50px;
            font-size: 1.3em;
            color: var(--dark-text);
            font-weight: 500;
        }
        .hidden { display: none !important; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) {
            .recorder-layout {
                flex-direction: column;
            }
            #summaryPanel {
                position: static;
                width: 100%;
                box-sizing: border-box;
                max-height: none;
                margin-bottom: 25px;
                order: -1;
            }
        }
        @media (max-width: 768px) {
            .header-nav {
                flex-direction: column;
                align-items: flex-start;
            }
            .user-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                width: 100%;
            }
            .user-info span {
                width: 100%;
                text-align: left;
            }
            .nav-link, .user-info button {
                width: auto;
                margin-bottom: 5px;
            }
            .cycle-grid, .meds-grid, .blood-gas-grid { grid-template-columns: 1fr; }
            .meds-form-container { flex-direction: column; }
            .meds-selection-group, .meds-details-group {
                min-width: unset;
                width: 100%;
            }
        }

        /* --- Footer Styles --- */
        footer {
            margin-top: 40px;
            padding: 20px 25px;
            text-align: center;
            font-size: 0.9em;
            color: #718096;
            border-top: 1px solid var(--medium-gray-border);
        }
        footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }
        footer a:hover { color: var(--secondary-color); }
    </style>
</head>
<body>

    <div id="loginView" class="container">
        <div class="login-box">
            <h2>CPR Case Recorder</h2>
            <p>กรุณาลงชื่อเข้าใช้เพื่อบันทึกและจัดการเคส</p>
            <button id="googleSignInBtn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                Sign in with Google
            </button>
            <p class="divider">หรือ</p>
            <div id="emailPasswordForm">
                <input type="email" id="emailInput" placeholder="อีเมล">
                <input type="password" id="passwordInput" placeholder="รหัสผ่าน">
                <button id="emailSignInBtn" class="primary">เข้าสู่ระบบด้วยอีเมล</button>
                <button id="emailSignUpBtn" class="secondary">สร้างบัญชีใหม่ด้วยอีเมล</button>
                <button type="button" id="forgotPasswordBtn" style="background: none; color: var(--primary-color); border: none; font-size: 0.9em; margin-top: 10px; padding: 5px 0;">ลืมรหัสผ่าน?</button>
            </div>
            <p id="loginError" class="hidden" style="color: var(--danger-color); margin-top: 15px; font-weight: 600;"></p>
        </div>
    </div>

    <div id="recorderView" class="container hidden">
        <div class="header-nav">
            <h1>บันทึกเคส CPR</h1>
            <div class="user-info">
                <span id="userNameRecorder"></span>
                <button id="manageCasesBtn" class="nav-link">จัดการเคส</button>
                <button id="logoutBtnRecorder" class="danger">ออกจากระบบ</button>
            </div>
        </div>

        <div class="recorder-layout">
            <div id="summaryPanel">
                <h3><i class="fas fa-clipboard-list"></i> Case Summary</h3>
                <div class="summary-section">
                    <p><strong>Patient:</strong> <span id="summaryPatientName">N/A</span></p>
                    <p><strong>Age:</strong> <span id="summaryAge">N/A</span></p>
                    <p><strong>Start Time:</strong> <span id="summaryStartTime">N/A</span></p>
                    <p><strong>Duration:</strong> <span id="summaryDuration">0 mins</span></p>
                </div>
                <div class="summary-section">
                    <p><strong>Medications:</strong> <span id="summaryMedCount">0</span></p>
                    <ul id="summaryMedList"></ul>
                </div>
                 <div class="summary-section">
                    <p><strong>Defibrillations:</strong> <span id="summaryDefibCount">0</span></p>
                    <ul id="summaryDefibList"></ul>
                </div>
            </div>

            <form id="cprForm">
                <fieldset>
                    <legend>ข้อมูลผู้ป่วย</legend>
                    <div class="cycle-grid">
                        <div>
                            <label>Date:</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="time-input-group">
                            <label>Time: <input type="time" name="time" required></label>
                            <button type="button" class="secondary use-now-btn">Now</button>
                        </div>
                        <div>
                            <label>HN:</label>
                            <input type="text" name="hn" required>
                        </div>
                        <div>
                            <label>Patient Name:</label>
                            <input type="text" name="patientName" required>
                        </div>
                        <div>
                            <label>Age:</label>
                            <input type="number" name="age" min="0" required>
                        </div>
                        <div>
                            <label>Event Details:</label>
                            <input type="text" name="eventDetails" placeholder="e.g., witnessed collapse">
                        </div>
                        <div class="time-input-group">
                            <label>ROSC Time: <input type="time" name="roscTime"></label>
                            <button type="button" class="secondary use-now-btn">Now</button>
                        </div>
                        <div class="time-input-group">
                            <label>NR Time: <input type="time" name="NRTime"></label>
                            <button type="button" class="secondary use-now-btn">Now</button>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>CPR Cycles</legend>
                    <div id="cyclesContainer"></div>
                    <button type="button" id="addCycleBtn" class="secondary">+ เพิ่ม CPR Cycle</button>
                </fieldset>
                <button type="submit" class="primary">บันทึกเคส</button>
            </form>
        </div>
    </div>

    <div id="manageView" class="container hidden">
        <div class="header-nav">
            <h1>จัดการข้อมูลเคส CPR</h1>
            <div class="user-info">
                <span id="userNameManage"></span>
                <button id="backToRecorderBtn" class="nav-link">&larr; กลับไปหน้าบันทึก</button>
                <button id="logoutBtnManage" class="danger">ออกจากระบบ</button>
            </div>
        </div>
        <div class="actions">
            <button id="exportBtn" class="primary">Export All (Excel)</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>HN</th>
                        <th>Patient Name</th>
                        <th id="recorderColumnHeader" class="hidden">Recorded By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="caseTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "cpr-record-2eadf.firebaseapp.com",
            projectId: "cpr-record-2eadf",
            storageBucket: "cpr-record-2eadf.appspot.com",
            messagingSenderId: "742246720333",
            appId: "1:742246720333:web:f6df16f6df6c8680d84d04",
            measurementId: "G-0P7R8M84F8"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signOut, GoogleAuthProvider,
            signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, query, where,
            onSnapshot, doc, deleteDoc, getDocs, setDoc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAILS = ["k.nattawit@gmail.com", "your.second.admin@example.com"];
        const loginView = document.getElementById('loginView');
        const recorderView = document.getElementById('recorderView');
        const manageView = document.getElementById('manageView');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const emailSignInBtn = document.getElementById('emailSignInBtn');
        const emailSignUpBtn = document.getElementById('emailSignUpBtn');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const loginError = document.getElementById('loginError');
        const cprForm = document.getElementById('cprForm');

        let currentUser = null;
        let isAdmin = false;
        let unsubscribe = null;
        let durationInterval = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userSnap = await getDoc(userDocRef);
                    if (!userSnap.exists()) {
                        await setDoc(userDocRef, {
                            uid: user.uid,
                            name: user.displayName || user.email.split('@')[0],
                            isAdmin: ADMIN_EMAILS.includes(user.email),
                            createdAt: new Date()
                        });
                        const newUserSnap = await getDoc(userDocRef);
                        isAdmin = newUserSnap.data().isAdmin || false;
                        updateUI(newUserSnap.data().name, isAdmin);
                    } else {
                        const userData = userSnap.data();
                        isAdmin = userData.isAdmin || false;
                        updateUI(userData.name, isAdmin);
                    }
                    showView('recorder');
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    signOut(auth);
                }
            } else {
                currentUser = null;
                isAdmin = false;
                showView('login');
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                loginError.classList.add('hidden');
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-in Error:", error);
                loginError.textContent = "เกิดข้อผิดพลาดในการลงชื่อเข้าใช้ด้วย Google";
                loginError.classList.remove('hidden');
            }
        });

        emailSignUpBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                loginError.textContent = "กรุณากรอกอีเมลและรหัสผ่าน";
                loginError.classList.remove('hidden');
                return;
            }
            try {
                loginError.classList.add('hidden');
                await createUserWithEmailAndPassword(auth, email, password);
                alert("สร้างบัญชีสำเร็จ! กรุณาเข้าสู่ระบบ");
                emailInput.value = '';
                passwordInput.value = '';
            } catch (error) {
                console.error("Email Sign-up Error:", error.code, error.message);
                loginError.textContent = "เกิดข้อผิดพลาดในการสร้างบัญชี: " + error.message;
                loginError.classList.remove('hidden');
            }
        });

        emailSignInBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                loginError.textContent = "กรุณากรอกอีเมลและรหัสผ่าน";
                loginError.classList.remove('hidden');
                return;
            }
            try {
                loginError.classList.add('hidden');
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Email Sign-in Error:", error.code, error.message);
                loginError.textContent = "เกิดข้อผิดพลาดในการลงชื่อเข้าใช้: " + error.message;
                loginError.classList.remove('hidden');
            }
        });
        
        forgotPasswordBtn.addEventListener('click', async () => {
            if (emailInput.value) {
                try {
                    await sendPasswordResetEmail(auth, emailInput.value);
                    alert("เราได้ส่งลิงก์รีเซ็ตรหัสผ่านไปที่อีเมลของคุณแล้ว");
                } catch (error) {
                    console.error("Password Reset Error:", error);
                    alert("เกิดข้อผิดพลาด: " + error.message);
                }
            } else {
                alert("กรุณาป้อนอีเมลของคุณ");
            }
        });

        function handleLogout() {
            signOut(auth).catch(error => console.error("Logout Error:", error));
        }

        function showView(viewName) {
            loginView.classList.add('hidden');
            recorderView.classList.add('hidden');
            manageView.classList.add('hidden');
            if (viewName === 'login') loginView.classList.remove('hidden');
            else if (viewName === 'recorder') {
                recorderView.classList.remove('hidden');
                setDefaultDateTime();
                updateSummaryPanel();
            } else if (viewName === 'manage') {
                manageView.classList.remove('hidden');
                loadCases();
            }
        }

        function updateUI(name, isAdmin) {
            document.getElementById('userNameRecorder').textContent = `สวัสดี, ${name}`;
            document.getElementById('userNameManage').textContent = `สวัสดี, ${name} ${isAdmin ? '(Admin)' : ''}`;
        }

        document.getElementById('logoutBtnRecorder').addEventListener('click', handleLogout);
        document.getElementById('logoutBtnManage').addEventListener('click', handleLogout);
        document.getElementById('manageCasesBtn').addEventListener('click', () => showView('manage'));
        document.getElementById('backToRecorderBtn').addEventListener('click', () => showView('recorder'));
        
        cprForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser) {
                alert("กรุณาเข้าสู่ระบบก่อนบันทึก");
                return;
            }
            const data = {};
            const formData = new FormData(cprForm);
            for (const [key, value] of formData.entries()) {
                 if (!key.startsWith('cycle-')) {
                    data[key] = value;
                 }
            }
            data.cycles = collectCyclesData();
            try {
                const userSnap = await getDoc(doc(db, "users", currentUser.uid));
                const userName = userSnap.exists() ? userSnap.data().name : 'Anonymous';
                await addDoc(collection(db, "cpr_cases"), { ...data, userId: currentUser.uid, userName, createdAt: new Date() });
                alert('บันทึกเคสสำเร็จ!');
                this.reset();
            } catch (error) {
                console.error("Error saving case: ", error);
                alert("เกิดข้อผิดพลาดในการบันทึกเคส");
            }
        });

        cprForm.addEventListener('reset', () => {
            document.getElementById("cyclesContainer").innerHTML = "";
            cycleCounter = 0;
            if (durationInterval) clearInterval(durationInterval);
            setTimeout(() => {
                setDefaultDateTime();
                updateSummaryPanel();
            }, 50);
        });

        const cyclesContainer = document.getElementById("cyclesContainer");
        let cycleCounter = 0;
        document.getElementById("addCycleBtn").addEventListener("click", () => {
            cycleCounter++;
            const cycleId = `cycle-${cycleCounter}`;
            const newCycle = document.createElement("div");
            newCycle.className = "cycle-block";
            newCycle.dataset.id = cycleId;
            newCycle.innerHTML = `
                <h3>Cycle ${cycleCounter}<button type="button" class="remove-btn" onclick="this.closest('.cycle-block').remove()">ลบ</button></h3>
                <div class="cycle-grid">
                    <div class="time-input-group">
                        <label>Time: <input type="time" name="${cycleId}-time"></label>
                        <button type="button" class="secondary use-now-btn">Now</button>
                    </div>
                    <label>Rhythm: 
                        <select name="${cycleId}-rhythm">
                            <option value="">Select...</option>
                            <option value="VF">VF</option><option value="VT">VT</option>
                            <option value="PEA">PEA</option><option value="Asystole">Asystole</option>
                        </select>
                    </label>
                    <label>Defib Energy (J): <input type="number" name="${cycleId}-defibEnergy" min="0"></label>
                </div>
                <hr>
                <details>
                    <summary>Medications & Interventions</summary>
                    <div class="meds-form-container">
                        <div class="meds-selection-group">
                            <label><input type="checkbox" name="${cycleId}-meds" value="Adrenaline"> Adrenaline</label>
                            <label><input type="checkbox" name="${cycleId}-meds" value="Amiodarone"> Amiodarone</label>
                            <label><input type="checkbox" name="${cycleId}-meds" value="Bicarbonate"> Bicarbonate</label>
                            <label><input type="checkbox" name="${cycleId}-meds" value="Calcium"> Calcium Gluconate</label>
                             <label><input type="checkbox" name="${cycleId}-meds" value="Lidocaine"> Lidocaine</label>
                        </div>
                        <div class="meds-details-group">
                             <label>Other Meds: <input type="text" name="${cycleId}-otherMeds" placeholder="e.g., Atropine 1mg"></label>
                             <div class="dtx-input-wrapper">
                                 <label>DTX (mg/dL): <input type="number" name="${cycleId}-dtx" min="0"></label>
                             </div>
                        </div>
                    </div>
                </details>`;
            cyclesContainer.appendChild(newCycle);
            const timeInput = newCycle.querySelector('input[type="time"]');
            setInputTimeToNow(timeInput);
        });
        
        function collectCyclesData() {
            const cyclesData = [];
            document.querySelectorAll('.cycle-block').forEach(cycleEl => {
                const cycleId = cycleEl.dataset.id;
                const meds = Array.from(cycleEl.querySelectorAll(`input[name="${cycleId}-meds"]:checked`)).map(cb => cb.value);
                cyclesData.push({
                    time: cycleEl.querySelector(`[name="${cycleId}-time"]`).value,
                    rhythm: cycleEl.querySelector(`[name="${cycleId}-rhythm"]`).value,
                    defibEnergy: cycleEl.querySelector(`[name="${cycleId}-defibEnergy"]`).value,
                    meds,
                    otherMeds: cycleEl.querySelector(`[name="${cycleId}-otherMeds"]`).value,
                    dtx: cycleEl.querySelector(`[name="${cycleId}-dtx"]`).value,
                });
            });
            return cyclesData;
        }

        function setInputTimeToNow(timeInput) {
            if (!timeInput) return;
            const now = new Date();
            timeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            timeInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function setDefaultDateTime() {
            const dateInput = document.querySelector('input[name="date"]');
            const timeInput = document.querySelector('input[name="time"]');
            const now = new Date();
            dateInput.value = now.toISOString().split('T')[0];
            setInputTimeToNow(timeInput);
        }

        recorderView.addEventListener('click', e => {
            if (e.target.classList.contains('use-now-btn')) {
                setInputTimeToNow(e.target.parentElement.querySelector('input[type="time"]'));
            } else if (e.target.type === 'checkbox' || e.target.classList.contains('remove-btn')) {
                setTimeout(updateSummaryPanel, 50);
            }
        });
        
        function startDurationTimer() {
            if (durationInterval) clearInterval(durationInterval);
            durationInterval = setInterval(() => {
                const startTimeInput = document.querySelector('input[name="time"]').value;
                const startDateInput = document.querySelector('input[name="date"]').value;
                const durationEl = document.getElementById('summaryDuration');
                if (startTimeInput && startDateInput) {
                    const [hours, minutes] = startTimeInput.split(':');
                    const startDateTime = new Date(startDateInput);
                    startDateTime.setHours(hours, minutes, 0, 0);
                    const diffMins = Math.floor((new Date() - startDateTime) / 60000);
                    durationEl.textContent = `${diffMins >= 0 ? diffMins : 0} mins`;
                }
            }, 5000);
        }

        function updateSummaryPanel() {
            document.getElementById('summaryPatientName').textContent = document.querySelector('input[name="patientName"]').value || 'N/A';
            document.getElementById('summaryAge').textContent = document.querySelector('input[name="age"]').value || 'N/A';
            const startTime = document.querySelector('input[name="time"]').value;
            document.getElementById('summaryStartTime').textContent = startTime || 'N/A';
            if (startTime) startDurationTimer();

            let medCount = 0;
            let defibCount = 0;
            const medList = [];
            const defibList = [];
            
            collectCyclesData().forEach((cycle, index) => {
                const timeLabel = cycle.time ? `@ ${cycle.time}` : `(Cycle ${index + 1})`;
                medCount += cycle.meds.length;
                cycle.meds.forEach(med => medList.push(`<li>${med} ${timeLabel}</li>`));
                if (cycle.otherMeds) {
                    medCount++;
                    medList.push(`<li>${cycle.otherMeds} ${timeLabel}</li>`);
                }
                if (cycle.defibEnergy && parseInt(cycle.defibEnergy, 10) > 0) {
                    defibCount++;
                    defibList.push(`<li>${cycle.defibEnergy}J ${timeLabel}</li>`);
                }
            });

            document.getElementById('summaryMedCount').textContent = medCount;
            document.getElementById('summaryMedList').innerHTML = medList.join('');
            document.getElementById('summaryDefibCount').textContent = defibCount;
            document.getElementById('summaryDefibList').innerHTML = defibList.join('');
        }

        cprForm.addEventListener('input', updateSummaryPanel);
        
        // --- Manage View Logic ---
        const caseTableBody = document.getElementById('caseTableBody');
        async function loadCases() {
            caseTableBody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
            const q = isAdmin ? query(collection(db, "cpr_cases")) : query(collection(db, "cpr_cases"), where("userId", "==", currentUser.uid));
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(q, (snapshot) => {
                caseTableBody.innerHTML = '';
                if (snapshot.empty) {
                    caseTableBody.innerHTML = `<tr><td colspan="${isAdmin ? 6 : 5}" class="no-cases">No cases found.</td></tr>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = caseTableBody.insertRow();
                    row.innerHTML = `<td>${data.date}</td><td>${data.time}</td><td>${data.hn}</td><td>${data.patientName}</td>${isAdmin ? `<td>${data.userName}</td>` : ''}<td><button class="danger remove-btn" data-id="${doc.id}">Delete</button></td>`;
                });
            });
        }
        caseTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-btn') && confirm('Are you sure?')) {
                await deleteDoc(doc(db, "cpr_cases", e.target.dataset.id));
            }
        });

        document.getElementById('exportBtn').addEventListener('click', async () => {
             const q = isAdmin ? query(collection(db, "cpr_cases")) : query(collection(db, "cpr_cases"), where("userId", "==", currentUser.uid));
             const snapshot = await getDocs(q);
             if (snapshot.empty) return alert("No data to export.");
             
             const dataToExport = [];
             snapshot.forEach(doc => {
                const data = doc.data();
                const base = { Date: data.date, Time: data.time, HN: data.hn, PatientName: data.patientName, Age: data.age, EventDetails: data.eventDetails, ROSCTime: data.roscTime, NRTime: data.NRTime, RecordedBy: data.userName };
                if (data.cycles?.length) {
                    data.cycles.forEach((c, i) => dataToExport.push({ ...base, Cycle: i + 1, CycleTime: c.time, Rhythm: c.rhythm, DefibEnergy: c.defibEnergy, Meds: [...c.meds, c.otherMeds].filter(Boolean).join(', '), DTX: c.dtx }));
                } else dataToExport.push(base);
             });
             
             const ws = XLSX.utils.json_to_sheet(dataToExport);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "CPR Cases");
             XLSX.writeFile(wb, "CPR_Cases_Export.xlsx");
        });

    </script>
</body>
</html>
