<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acetaminophen Poisoning Management Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark text */
        }
        .card {
            background-color: #ffffff; /* White card */
            border: 1px solid #e5e7eb; /* Light border */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            background-color: #3b82f6; /* Blue button */
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        input, select {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            color: #1f2937;
        }
        .result-box {
            background-color: #eff6ff; /* Light blue background */
            border-left: 4px solid #3b82f6;
        }
        .header-text {
            color: #111827;
        }
        .label-text {
            color: #374151;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold header-text">เครื่องมือจัดการภาวะพิษจากยาพาราเซตามอล</h1>
            <p class="text-lg text-gray-600 mt-2">Acetaminophen Poisoning Management Tool (อ้างอิงแนวทาง 2023)</p>
        </header>

        <!-- Patient Assessment Section -->
        <div class="card rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2">1. ประเมินผู้ป่วยตามสถานการณ์</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <label for="scenario" class="block text-sm font-medium label-text mb-2">เลือกสถานการณ์ผู้ป่วย:</label>
                    <select id="scenario" class="w-full rounded-md p-2">
                        <option value="acute">Acute Ingestion (ทราบเวลาชัดเจน, < 24 ชม.)</option>
                        <option value="unknown">Unknown Time / Unreliable History</option>
                        <option value="repeated">Repeated Supratherapeutic Ingestion (RSI)</option>
                        <option value="extended">Extended-Release / Co-ingestion</option>
                    </select>
                </div>
                <div id="assessment-result" class="result-box p-4 rounded-md mt-4 md:mt-0 h-full">
                    <h3 class="font-bold text-lg mb-2">คำแนะนำเบื้องต้น:</h3>
                    <p id="scenario-advice">เลือกสถานการณ์เพื่อดูคำแนะนำ</p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Nomogram Section -->
            <div class="card rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2">2. Modified Rumack-Matthew Nomogram</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="time-since-ingestion" class="block text-sm font-medium label-text">เวลาหลังได้รับยา (ชม.)</label>
                        <input type="number" id="time-since-ingestion" placeholder="4-24" class="w-full mt-1 rounded-md p-2">
                    </div>
                    <div>
                        <label for="apap-level" class="block text-sm font-medium label-text">ระดับยา APAP (µg/mL)</label>
                        <input type="number" id="apap-level" placeholder="เช่น 150" class="w-full mt-1 rounded-md p-2">
                    </div>
                    <button id="plot-button" class="btn text-white font-bold rounded-md sm:self-end h-10">Plot Point</button>
                </div>
                <div id="plot-result" class="text-center font-semibold text-lg p-2 min-h-[40px]"></div>
                <div class="relative h-96 w-full">
                    <canvas id="nomogramChart"></canvas>
                </div>
            </div>

            <!-- NAC Dose Calculator -->
            <div class="card rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2">3. คำนวณขนาดยา Acetylcysteine (IV NAC)</h2>
                <div class="flex items-end gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="patient-weight" class="block text-sm font-medium label-text">น้ำหนักผู้ป่วย (kg)</label>
                        <input type="number" id="patient-weight" placeholder="เช่น 60" class="w-full mt-1 rounded-md p-2">
                    </div>
                    <button id="calculate-nac" class="btn text-white font-bold rounded-md h-10 px-6">คำนวณ</button>
                </div>
                <div id="nac-result" class="space-y-3">
                </div>
            </div>
        </div>
        
        <!-- Special Cases Section -->
        <div class="card rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2">4. เกณฑ์การพิจารณาพิเศษ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-emerald-600 mb-2">เกณฑ์การหยุดยา NAC</h3>
                    <p class="text-sm mb-2">(ต้องเข้าได้ทุกข้อ)</p>
                    <ul class="list-disc list-inside space-y-1 label-text">
                        <li>ระดับยา Acetaminophen < 10 µg/mL</li>
                        <li>INR < 2.0</li>
                        <li>AST/ALT ปกติ หรือลดลง >25-50% จากค่าสูงสุด</li>
                        <li>ผู้ป่วยอาการทางคลินิกดีขึ้น</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-sky-600 mb-2">การพิจารณาฟอกไต (Hemodialysis)</h3>
                     <ul class="list-disc list-inside space-y-1 label-text">
                        <li>ระดับยา Acetaminophen สูงมาก (≥ 900 µg/mL)</li>
                        <li>มีภาวะเลือดเป็นกรด (Acidosis) รุนแรง</li>
                        <li>มีภาวะซึมเศร้า (Altered consciousness)</li>
                        <li class="mt-2 pt-2 border-t border-gray-200"><strong>การให้ NAC ระหว่างฟอกไต:</strong> เพิ่มอัตราเร็วเป็นอย่างน้อย 12.5 mg/kg/hr</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-red-600 mb-2">การพิจารณาปลูกถ่ายตับ (King's College)</h3>
                    <p class="text-sm mb-2">ปรึกษาทีมปลูกถ่ายตับหากเข้าได้กับเกณฑ์ข้อใดข้อหนึ่ง</p>
                    <ul class="list-disc list-inside space-y-1 label-text">
                         <li><strong>Lactate > 3.0 mmol/L</strong> (หลังให้สารน้ำเต็มที่)</li>
                        <li>Arterial pH < 7.30 (หลังให้สารน้ำเต็มที่)</li>
                        <li class="font-semibold">หรือมี 3 ข้อต่อไปนี้ร่วมกัน:</li>
                         <ul class="list-['-_'] ml-6">
                            <li>Prothrombin time > 100s (INR > 6.5)</li>
                            <li>Serum creatinine > 3.4 mg/dL</li>
                            <li>Grade III-IV hepatic encephalopathy</li>
                         </ul>
                    </ul>
                </div>
            </div>
        </div>

        <!-- NAC Adverse Reaction Management -->
        <div class="card rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-200 pb-2">5. การจัดการผลข้างเคียงจากยา NAC</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="result-box p-4 rounded-md border-yellow-500">
                    <h4 class="font-bold text-lg">Flushing (หน้าแดง)</h4>
                    <p class="text-sm">ประเมินความจำเป็นในการให้ยาต่อ หากจำเป็นให้ต่อได้โดยไม่ต้องหยุดยา</p>
                </div>
                 <div class="result-box p-4 rounded-md border-orange-500">
                    <h4 class="font-bold text-lg">Urticaria (ผื่นลมพิษ)</h4>
                    <p class="text-sm">ให้ยา Diphenhydramine 1 mg/kg IV (max 50 mg) และให้ NAC ต่อได้</p>
                </div>
                 <div class="result-box p-4 rounded-md border-red-500">
                    <h4 class="font-bold text-lg">Angioedema (อาการบวม)</h4>
                    <p class="text-sm">หยุดยา NAC ทันที, ให้ Diphenhydramine. หากอาการดีขึ้นใน 1 ชม. สามารถเริ่มยาใหม่ได้</p>
                </div>
                 <div class="result-box p-4 rounded-md border-red-700">
                    <h4 class="font-bold text-lg">Anaphylaxis / Hypotension</h4>
                    <p class="text-sm">หยุดยา NAC ทันที, รักษาตามแนวทาง Anaphylaxis. หากจำเป็นต้องให้ยาต่อ ให้เริ่มใหม่ในอัตราที่ช้าลงและปรึกษาผู้เชี่ยวชาญ</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const scenarioSelect = document.getElementById('scenario');
            const scenarioAdvice = document.getElementById('scenario-advice');
            
            const timeInput = document.getElementById('time-since-ingestion');
            const levelInput = document.getElementById('apap-level');
            const plotButton = document.getElementById('plot-button');
            const plotResult = document.getElementById('plot-result');

            const weightInput = document.getElementById('patient-weight');
            const calculateNacButton = document.getElementById('calculate-nac');
            const nacResultDiv = document.getElementById('nac-result');

            const scenarios = {
                acute: 'เจาะเลือดวัดระดับ Acetaminophen ที่เวลา 4-24 ชั่วโมงหลังได้รับยา แล้วนำค่าไป plot บน Nomogram เพื่อประเมินความเสี่ยง หากผลเลือดจะออกช้า (> 8 ชม. หลังกินยา) หรือกินยาในขนาดสูงมาก (≥30 g) ให้เริ่มให้ NAC ไปก่อน',
                unknown: 'เจาะเลือดวัดระดับ Acetaminophen, AST, ALT ทันที / ให้ NAC หากระดับยา > 10 µg/mL หรือค่า AST/ALT ผิดปกติ',
                repeated: 'เจาะเลือดวัดระดับ Acetaminophen, AST, ALT, Creatinine / ให้ NAC หากระดับยา ≥ 20 µg/mL หรือค่า AST/ALT ผิดปกติ',
                extended: 'เจาะเลือดที่ 4-12 ชั่วโมงหลังได้รับยา หากระดับยาอยู่ใต้เส้น Treatment Line แต่ > 10 µg/mL ให้เจาะเลือดซ้ำในอีก 4-6 ชั่วโมง'
            };

            function updateScenarioAdvice() {
                scenarioAdvice.textContent = scenarios[scenarioSelect.value];
            }
            scenarioSelect.addEventListener('change', updateScenarioAdvice);
            updateScenarioAdvice();

            const ctx = document.getElementById('nomogramChart').getContext('2d');
            
            const k_treat = Math.log(150/5) / 20;
            const A_treat = 150 / Math.exp(-k_treat * 4);
            const treatmentLineData = Array.from({length: 21}, (_, i) => ({x: i + 4, y: A_treat * Math.exp(-k_treat * (i+4))}));

            const k_risk = Math.log(300/10) / 20;
            const A_risk = 300 / Math.exp(-k_risk * 4);
            const highRiskLineData = Array.from({length: 21}, (_, i) => ({x: i + 4, y: A_risk * Math.exp(-k_risk * (i+4))}));

            const nomogramChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Treatment Line',
                        data: treatmentLineData,
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        showLine: true,
                    }, {
                        label: 'High-Risk Line',
                        data: highRiskLineData,
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        showLine: true
                    }, {
                        label: 'Patient Level',
                        data: [],
                        backgroundColor: '#3b82f6',
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear', position: 'bottom',
                            title: { display: true, text: 'Time Since Ingestion (hours)', color: '#4b5563' },
                            min: 0, max: 28, ticks: { color: '#6b7280' }
                        },
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Acetaminophen Concentration (µg/mL)', color: '#4b5563' },
                            min: 1, max: 500,
                            ticks: { color: '#6b7280', callback: (value) => Number(value.toString()) }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#374151' } },
                        tooltip: { callbacks: { label: (c) => `${c.dataset.label}: (${c.parsed.x}h, ${c.parsed.y.toFixed(1)} µg/mL)` } }
                    }
                }
            });
            
            plotButton.addEventListener('click', () => {
                const time = parseFloat(timeInput.value);
                const level = parseFloat(levelInput.value);

                if (isNaN(time) || isNaN(level) || time < 4 || time > 24) {
                    plotResult.textContent = 'กรุณาใส่ข้อมูลเวลา (4-24 ชม.) และระดับยาให้ถูกต้อง';
                    plotResult.className = 'text-center font-semibold text-lg p-2 text-orange-600';
                    return;
                }
                
                nomogramChart.data.datasets[2].data = [{ x: time, y: level }];
                nomogramChart.update();

                const treatmentLevel = A_treat * Math.exp(-k_treat * time);
                const highRiskLevel = A_risk * Math.exp(-k_risk * time);

                if (level >= highRiskLevel) {
                    plotResult.textContent = 'อยู่เหนือเส้น High-Risk Line - พิจารณาให้ NAC ขนาดสูง';
                    plotResult.className = 'text-center font-semibold text-lg p-2 text-red-600';
                } else if (level >= treatmentLevel) {
                    plotResult.textContent = 'อยู่เหนือเส้น Treatment Line - แนะนำให้เริ่ม NAC';
                    plotResult.className = 'text-center font-semibold text-lg p-2 text-amber-600';
                } else {
                    plotResult.textContent = 'อยู่ใต้เส้น Treatment Line - ยังไม่จำเป็นต้องให้ NAC';
                    plotResult.className = 'text-center font-semibold text-lg p-2 text-green-600';
                }
            });

            calculateNacButton.addEventListener('click', () => {
                const weight = parseFloat(weightInput.value);
                if (isNaN(weight) || weight <= 0) {
                    nacResultDiv.innerHTML = `<p class="text-amber-600">กรุณาใส่น้ำหนักให้ถูกต้อง</p>`;
                    return;
                }

                const calculationWeight = Math.min(weight, 100);
                const weightCapped = weight > 100;

                const loadingDoseMg = 150 * calculationWeight;
                const secondDoseMg = 50 * calculationWeight;
                const thirdDoseMg = 100 * calculationWeight;

                const loadingFluid = weight < 21 ? 3 * calculationWeight : (weight < 41 ? 100 : 200);
                const secondFluid = weight < 21 ? 7 * calculationWeight : (weight < 41 ? 250 : 500);
                const thirdFluid = weight < 21 ? 14 * calculationWeight : (weight < 41 ? 500 : 1000);

                nacResultDiv.innerHTML = `
                    ${weightCapped ? `<div class="result-box p-3 rounded-md border-amber-500"><p class="text-amber-600 font-semibold">หมายเหตุ: น้ำหนักที่ใช้คำนวณถูกจำกัดไว้ที่ 100 kg</p></div>` : ''}
                    <div class="result-box p-4 rounded-md">
                        <h4 class="font-bold text-lg">Loading Dose (1 ชั่วโมง)</h4>
                        <p>${loadingDoseMg.toFixed(0)} mg NAC in D5W ${loadingFluid} mL, IV drip over 60 minutes</p>
                    </div>
                    <div class="result-box p-4 rounded-md">
                        <h4 class="font-bold text-lg">Second Dose (4 ชั่วโมง)</h4>
                        <p>${secondDoseMg.toFixed(0)} mg NAC in D5W ${secondFluid} mL, IV drip over 4 hours</p>
                    </div>
                    <div class="result-box p-4 rounded-md">
                        <h4 class="font-bold text-lg">Third Dose (16 ชั่วโมง)</h4>
                        <p>${thirdDoseMg.toFixed(0)} mg NAC in D5W ${thirdFluid} mL, IV drip over 16 hours</p>
                    </div>
                `;
            });
        });
    </script>

</body>
</html>
