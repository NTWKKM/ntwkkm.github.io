<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การจัดการภาวะเป็นพิษจากยาพาราเซตามอล (Acetaminophen)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .flow-arrow {
            font-size: 2rem;
            line-height: 1;
            color: #94d2bd;
        }
        .flow-card {
            border: 2px solid #0a9396;
        }
        .spinner {
            border-color: #f3f3f3;
            border-top-color: #0a9396;
        }
    </style>
</head>
<body class="bg-[#001219] text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-5xl font-bold text-[#94d2bd] mb-2">การจัดการภาวะเป็นพิษจากยาพาราเซตามอล</h1>
            <p class="text-lg text-[#e9d8a6]">สรุปแนวทางฉันทามติสหรัฐอเมริกาและแคนาดา ปี 2023</p>
        </header>

        <main>
            <section id="thresholds" class="mb-12">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-8">1. เกณฑ์การวินิจฉัยการใช้ยาเกินขนาด (Thresholds for Overdose)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow-xl p-6 text-center transform hover:scale-105 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-[#005f73] mb-2">ผู้ใหญ่และเด็ก ≥ 6 ปี (ครั้งเดียว)</h3>
                        <p class="text-4xl font-bold text-[#0a9396]">>10 ก.</p>
                        <p class="text-2xl text-gray-600">หรือ >200 มก./กก.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-xl p-6 text-center transform hover:scale-105 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-[#005f73] mb-2">เด็กเล็ก < 6 ปี</h3>
                        <p class="text-4xl font-bold text-[#0a9396]">>200 มก./กก.</p>
                        <p class="text-2xl text-gray-600">(ในช่วง 8 ชั่วโมง)</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-xl p-6 text-center transform hover:scale-105 transition-transform duration-300 md:col-span-2 lg:col-span-1">
                        <h3 class="text-xl font-bold text-[#ae2012] mb-2">การใช้ยาเกินขนาดปริมาณมาก</h3>
                        <p class="text-4xl font-bold text-[#9b2226]">>40 ก.</p>
                        <p class="text-2xl text-gray-600">หรือ >500 มก./กก.</p>
                    </div>
                </div>
                 <div class="mt-6 bg-white rounded-lg shadow-xl p-6">
                    <h3 class="text-xl font-bold text-center text-[#005f73] mb-4">เปรียบเทียบเกณฑ์การรับประทานต่อเนื่อง (Supratherapeutic)</h3>
                    <div class="chart-container">
                        <canvas id="supratherapeuticChart"></canvas>
                    </div>
                    <p class="text-center text-gray-600 mt-4">แผนภูมินี้เปรียบเทียบปริมาณยาต่อวัน (มก./กก.) ที่ถือว่าเป็นพิษเมื่อรับประทานต่อเนื่องในกลุ่มผู้ใหญ่และเด็ก ซึ่งแสดงให้เห็นว่าเกณฑ์สำหรับเด็กจะต่ำกว่าเมื่อเทียบกับผู้ใหญ่</p>
                </div>
            </section>

            <section id="management" class="mb-12">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-8">2. การประเมินและการรักษาเบื้องต้น</h2>
                <div class="bg-white rounded-lg shadow-xl p-6">
                    <div class="flex flex-col items-center">
                        <div class="flow-card bg-white rounded-lg shadow-md p-4 w-full md:w-3/4 text-center">
                            <h3 class="font-bold text-[#005f73]">ผู้ป่วยมาถึง ER</h3>
                            <p>ซักประวัติเวลาและปริมาณยาที่รับประทาน</p>
                        </div>
                        <div class="flow-arrow">↓</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">
                            <div class="flow-card bg-white rounded-lg shadow-md p-4 text-center">
                                <h4 class="font-semibold text-[#0a9396]">&lt; 4 ชั่วโมง</h4>
                                <p>พิจารณา Activated Charcoal</p>
                            </div>
                            <div class="flow-card bg-white rounded-lg shadow-md p-4 text-center">
                                <h4 class="font-semibold text-[#ee9b00]">4 - 24 ชั่วโมง</h4>
                                <p>เจาะระดับยา APAP และพลอตบน Nomogram</p>
                            </div>
                            <div class="flow-card bg-white rounded-lg shadow-md p-4 text-center">
                                <h4 class="font-semibold text-[#ca6702]">ไม่ทราบเวลา / ต่อเนื่อง</h4>
                                <p>เจาะ APAP, AST/ALT, INR และพิจารณาให้ NAC ทันที</p>
                            </div>
                        </div>
                    </div>
                     <p class="text-center text-gray-600 mt-6">แผนผังนี้แสดงขั้นตอนการตัดสินใจเบื้องต้นตามเวลาที่ผู้ป่วยรับประทานยาพาราเซตามอลเกินขนาด ซึ่งเป็นหัวใจสำคัญในการเริ่มการรักษาที่ถูกต้องและทันท่วงที</p>
                </div>
            </section>
            
            <section id="nac" class="mb-12">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-8">3. บทบาทของยาต้านพิษ: Acetylcysteine (NAC)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold text-[#005f73] mb-4">ข้อบ่งชี้หลักในการให้ NAC</h3>
                        <ul class="list-disc list-inside space-y-2 text-lg">
                            <li>ระดับยา APAP สูงกว่า <span class="font-bold text-[#0a9396]">Treatment Line</span> บน Nomogram</li>
                            <li>รับประทานยาเกินขนาดปริมาณมาก (<span class="font-bold text-[#9b2226]">>30 กรัม</span>) ให้ทันที</li>
                            <li>รับประทานต่อเนื่องและมีระดับยา <span class="font-bold text-[#ca6702]">>20 μg/mL</span> หรือ <span class="font-bold text-[#ca6702]">AST/ALT ผิดปกติ</span></li>
                        </ul>
                    </div>
                    <div class="bg-white rounded-lg shadow-xl p-6 text-center">
                        <h3 class="text-xl font-bold text-[#005f73] mb-2">ปริมาณยาที่แนะนำ</h3>
                        <p class="text-5xl font-bold text-[#0a9396]">≥300</p>
                        <p class="text-2xl text-gray-600">มก./กก. ใน 20-24 ชั่วโมงแรก</p>
                        <p class="mt-4 text-red-600 font-semibold">ข้อควรระวังในผู้ป่วยเด็ก (&lt;41 กก.): ต้องปรับปริมาณยาตามน้ำหนักเพื่อป้องกันภาวะโซเดียมต่ำและน้ำเกิน</p>
                    </div>
                </div>
            </section>

            <section id="special" class="mb-12">
                 <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-8">4. ภาวะที่ต้องได้รับการดูแลเป็นพิเศษ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold text-[#005f73] mb-4">การกำจัดสารพิษเสริม (Enhanced Elimination)</h3>
                        <p class="mb-2">พิจารณา <span class="font-bold text-[#0a9396]">การฟอกไต (Hemodialysis)</span> ร่วมกับ NAC หาก:</p>
                        <ul class="list-disc list-inside space-y-2">
                             <li>ระดับยาพาราเซตามอล <span class="font-extrabold text-[#9b2226]">> 900 μg/mL</span></li>
                             <li>มีภาวะ <span class="font-bold text-[#ae2012]">กรดเกิน (Acidosis)</span> อย่างรุนแรง</li>
                        </ul>
                    </div>
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold text-[#005f73] mb-4">การปรึกษาทีมปลูกถ่ายตับ (Liver Transplant)</h3>
                        <p class="mb-2">พิจารณาปรึกษาเมื่อมีภาวะตับวายเฉียบพลัน โดยใช้เกณฑ์ เช่น <span class="font-bold text-[#ca6702]">King's College Criteria</span> หากพบว่า:</p>
                         <ul class="list-disc list-inside space-y-2">
                            <li><span class="font-bold">AST/ALT</span> เพิ่มขึ้นต่อเนื่อง</li>
                            <li><span class="font-bold">Coagulopathy</span> (INR สูง)</li>
                            <li><span class="font-bold">Encephalopathy</span> (สมองบวม)</li>
                        </ul>
                        
                        <!-- New LLM Feature for KCC Summary -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                             <button id="summarizeKCCButton" class="w-full py-2 px-4 rounded-lg bg-[#ee9b00] text-gray-900 font-semibold text-sm hover:bg-[#ca6702] transition duration-300 flex items-center justify-center">
                                <span id="kccButtonText">สรุป King's College Criteria โดยละเอียด ✨</span>
                                <div id="kccLoadingIndicator" class="hidden spinner ml-3 border-4 border-t-4 border-gray-200 border-t-white h-4 w-4 rounded-full animate-spin"></div>
                            </button>
                            <div id="kccOutput" class="mt-3 p-3 text-sm bg-gray-50 border-l-4 border-[#ee9b00] rounded-r-lg text-gray-900">
                                <p class="italic">กดปุ่มด้านบนเพื่อดูสรุปเกณฑ์</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="clinical-tool" class="mb-12">
                <h2 class="text-2xl md:text-3xl font-bold text-center text-white mb-8">5. ✨ เครื่องมือฝึกฝนทางคลินิก (Clinical Practice Tool) ✨</h2>
                <div class="bg-white rounded-lg shadow-xl p-6">
                    <p class="text-gray-700 mb-4">กดปุ่มด้านล่างเพื่อสร้างกรณีศึกษาภาวะเป็นพิษจากยาพาราเซตามอลแบบสุ่ม พร้อมค่าพารามิเตอร์สำคัญที่ต้องนำไปประเมินตามแนวทางปฏิบัติ เพื่อใช้ฝึกฝนการตัดสินใจ</p>
                    <button id="generateCaseButton" class="w-full py-3 px-4 rounded-lg bg-[#0a9396] text-white font-semibold hover:bg-[#005f73] transition duration-300 flex items-center justify-center">
                        <span id="buttonText">สร้างกรณีศึกษาใหม่ ✨</span>
                        <div id="loadingIndicator" class="hidden spinner ml-3 border-4 border-t-4 border-gray-200 border-t-white h-5 w-5 rounded-full animate-spin"></div>
                    </button>
                    
                    <div id="caseOutput" class="mt-6 p-4 bg-[#e9d8a6] border-l-4 border-[#ae2012] rounded-r-lg text-gray-900 min-h-[100px] flex items-center justify-center">
                         <p class="text-center italic">กรณีศึกษาจะปรากฏที่นี่</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-10 border-t border-[#0a9396] pt-6">
            <p class="text-white text-lg">การประเมินความเสี่ยงอย่างรวดเร็วและการให้ยาต้านพิษ (NAC) อย่างทันท่วงที คือหัวใจสำคัญของการรักษา</p>
        </footer>

    </div>

    <script>
        const API_KEY = ""; // Provided by the environment
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;

        const fetchWithBackoff = async (url, options, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                        continue;
                    }
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorBody.error.message}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        };

        const generateCaseScenario = async () => {
            const button = document.getElementById('generateCaseButton');
            const buttonText = document.getElementById('buttonText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const outputDiv = document.getElementById('caseOutput');
            
            button.disabled = true;
            buttonText.textContent = 'กำลังสร้าง...';
            loadingIndicator.classList.remove('hidden');
            outputDiv.innerHTML = `<p class="text-center text-gray-600">กำลังสร้างกรณีศึกษา...</p>`;
            
            // System instruction in English to maintain model persona and accuracy
            const systemPrompt = "You are an expert toxicologist specializing in acetaminophen poisoning management. Your task is to generate a realistic, concise clinical case scenario based on the 2023 US/Canadian consensus guidelines. The case must include: 1. Patient demographics (Age > 6 years, approximate Weight in kg). 2. Time since ingestion (4-24 hours). 3. Approximate amount of APAP ingested (in grams, relevant to high-risk thresholds). 4. Initial APAP level (in μg/mL or mg/L) and/or initial AST/ALT values. The output should be strictly the case text, without introduction or analysis. Write the response in Thai.";
            // User query in Thai to get the output in Thai
            const userQuery = "สร้างกรณีศึกษาเดียวเกี่ยวกับการใช้ยาพาราเซตามอลเกินขนาด (Acetaminophen Overdose) ที่ต้องเริ่มการรักษาด้วย Acetylcysteine (NAC) โดยอิงตาม Rumack-Matthew nomogram";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = `<p class="whitespace-pre-wrap">${generatedText}</p>`;
                } else {
                    outputDiv.innerHTML = `<p class="text-red-600 text-center">ไม่สามารถสร้างกรณีศึกษาได้ โปรดลองอีกครั้ง</p>`;
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputDiv.innerHTML = `<p class="text-red-600 text-center">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</p>`;
            } finally {
                buttonText.textContent = 'สร้างกรณีศึกษาใหม่ ✨';
                loadingIndicator.classList.add('hidden');
                button.disabled = false;
            }
        };
        
        const summarizeKCCriteria = async () => {
            const button = document.getElementById('summarizeKCCButton');
            const buttonText = document.getElementById('kccButtonText');
            const loadingIndicator = document.getElementById('kccLoadingIndicator');
            const outputDiv = document.getElementById('kccOutput');
            
            button.disabled = true;
            buttonText.textContent = 'กำลังสรุป...';
            loadingIndicator.classList.remove('hidden');
            outputDiv.innerHTML = `<p class="text-center text-gray-600">กำลังดึงข้อมูล...</p>`;
            
            // System instruction: Act as a specialist and provide a structured summary for Acetaminophen cases.
            const systemPrompt = "You are an expert toxicologist providing concise clinical summaries. Your task is to briefly and accurately summarize the King's College Criteria specifically for Acetaminophen-induced acute liver failure (ALF) in a structured, easy-to-read format. The summary must list the criteria required for transplantation consideration. Write the response strictly in Thai.";
            
            // User query: Request the summary of KCC.
            const userQuery = "สรุปเกณฑ์ King's College (King's College Criteria) สำหรับภาวะตับวายเฉียบพลันจากยาพาราเซตามอล (Acetaminophen-induced ALF) อย่างกระชับ";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = `<p class="whitespace-pre-wrap">${generatedText}</p>`;
                } else {
                    outputDiv.innerHTML = `<p class="text-red-600 text-center">ไม่สามารถสรุปเกณฑ์ได้ โปรดลองอีกครั้ง</p>`;
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputDiv.innerHTML = `<p class="text-red-600 text-center">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</p>`;
            } finally {
                buttonText.textContent = 'สรุป King\'s College Criteria โดยละเอียด ✨';
                loadingIndicator.classList.add('hidden');
                button.disabled = false;
            }
        };


        document.addEventListener('DOMContentLoaded', function () {
            // Chart initialization logic
            const wrapLabel = (label, maxLength) => {
                const words = label.split(' ');
                let lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length > maxLength) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                });
                lines.push(currentLine.trim());
                return lines;
            };

            const supratherapeuticData = {
                labels: [wrapLabel('ผู้ใหญ่และเด็ก ≥ 6 ปี', 16), wrapLabel('เด็กเล็ก < 6 ปี', 16)],
                datasets: [{
                    label: 'เกณฑ์การรับประทานต่อเนื่อง (มก./กก./วัน)',
                    data: [150, 150],
                    backgroundColor: ['#0a9396', '#ee9b00'],
                    borderColor: ['#005f73', '#ca6702'],
                    borderWidth: 2,
                    barThickness: 50,
                }]
            };

            const supratherapeuticConfig = {
                type: 'bar',
                data: supratherapeuticData,
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ปริมาณยา (มก./กก./วัน)',
                                color: '#333',
                                font: { size: 14 }
                            },
                            ticks: { color: '#333' }
                        },
                        y: {
                           ticks: { color: '#333', font: { size: 12 } }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    let label = item.chart.data.labels[item.dataIndex];
                                    if (Array.isArray(label)) {
                                      return label.join(' ');
                                    } else {
                                      return label;
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            const supratherapeuticCtx = document.getElementById('supratherapeuticChart').getContext('2d');
            new Chart(supratherapeuticCtx, supratherapeuticConfig);

            // Gemini API Feature Setup
            document.getElementById('generateCaseButton').addEventListener('click', generateCaseScenario);
            document.getElementById('summarizeKCCButton').addEventListener('click', summarizeKCCriteria);
        });
    </script>

</body>
</html>