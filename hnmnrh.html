<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทดสอบยิง AJAX (จริง) - v2</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 500px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="text"] { width: calc(100% - 90px); padding: 8px; font-size: 16px; margin-right: 10px; }
        button { padding: 8px 12px; font-size: 16px; cursor: pointer; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; word-wrap: break-word; }
        .loading { background-color: #eee; color: #555; }
        .error { background-color: #ffeeee; color: #cc0000; }
        .success { background-color: #e0ffe0; color: #006600; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ทดสอบยิง AJAX (v2 - Form Encoded)</h2>
        
        <label for="hnInput">กรอก HN:</label>
        <input type="text" id="hnInput" placeholder="HN คนไข้">
        <button id="searchButton">ยิง Request</button>

        <div id="result">โปรดกรอก HN แล้วกดปุ่ม</div>
        <div id="full-response" style="margin-top: 10px; font-size: 0.8em; color: #666;"></div>
    </div>

    <script>
        const hnInput = document.getElementById("hnInput");
        const searchButton = document.getElementById("searchButton");
        const resultDiv = document.getElementById("result");
        const fullResponseDiv = document.getElementById("full-response");

        const TARGET_URL = "http://49.231.247.56/iReportAG/Result/Mng_Action/Search";

        searchButton.addEventListener("click", async () => {
            const hn = hnInput.value.trim();
            if (!hn) {
                resultDiv.className = "error";
                resultDiv.textContent = "กรุณากรอก HN";
                return;
            }

            resultDiv.className = "loading";
            resultDiv.textContent = "กำลังยิง AJAX (Form Encoded) ไปที่ " + TARGET_URL;
            fullResponseDiv.textContent = "";
            searchButton.disabled = true;

            // 2. สร้าง Payload (ข้อมูลที่จะส่ง)
            const payloadData = {
                SearchVal: hn,      // HN ที่รับมา
                SearchFld: "hn",  // ประเภทการค้นหา
                DateOpt: "3",     // ค่าเริ่มต้น "3 วัน"
                LabGrp: "0",      // ค่าเริ่มต้น "ทั้งหมด"
                Sts: "3",         // ค่าเริ่มต้น "มีผล"
                WardNo: ""        // ค่าเริ่มต้น "ว่าง"
            };

            // ---- [ส่วนที่แก้ไข] ----
            // สร้างข้อมูลแบบ Form-encoded
            const formData = new URLSearchParams();
            formData.append("cmd", "RequestSearch");
            formData.append("data", JSON.stringify(payloadData)); // ส่ง object data เป็น string
            // ---- [จบส่วนที่แก้ไข] ----

            try {
                // 3. ยิง AJAX Request ด้วย 'fetch'
                const response = await fetch(TARGET_URL, {
                    method: 'POST',
                    // ---- [ส่วนที่แก้ไข] ----
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: formData.toString() // แปลง formData เป็น string
                    // ---- [จบส่วนที่แก้ไข] ----
                });

                if (!response.ok) {
                    throw new Error(`Server ตอบกลับมามีปัญหา: ${response.status}`);
                }

                // 4. แปลงคำตอบกลับเป็น JSON
                const data = await response.json();

                // 5. แสดงผล (ถ้าสำเร็จ)
                console.log("Full response:", data);
                fullResponseDiv.textContent = JSON.stringify(data, null, 2);

                if (data.RequestList && data.RequestList.length > 0) {
                    const patient = data.RequestList[0];
                    const patientName = patient.PatName || "N/A"; 
                    const patientHN = patient.HN || hn;

                    resultDiv.className = "success";
                    resultDiv.textContent = `สำเร็จ (เชื่อมต่อได้!): ${patientName} (HN: ${patientHN})`;
                } else {
                    resultDiv.className = "error";
                    resultDiv.textContent = "สำเร็จ แต่ Server ไม่คืนข้อมูลคนไข้";
                }

            } catch (error) {
                // 6. แสดงผล (ถ้าล้มเหลว - ซึ่งเป็นสิ่งที่เราคาดหวัง)
                console.error("Fetch Error:", error);
                resultDiv.className = "error";
                resultDiv.textContent = "ยิง AJAX ล้มเหลว (ตามคาด): " + error.message;
                
                fullResponseDiv.textContent = "ดูใน Console (F12) จะเห็น Error 'CORS policy' ครับ";
            } finally {
                searchButton.disabled = false;
            }
        });
    </script>

</body>
</html>
