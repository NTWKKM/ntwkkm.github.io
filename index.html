<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>วิธีติดตั้ง n8n บน Fly.io แบบฟรีตลอดชีพ (Free Tier Optimized)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fcfcfc;
        }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h2 { color: #e67e22; margin-top: 35px; border-left: 4px solid #e67e22; padding-left: 10px; }
        h3 { color: #34495e; margin-top: 25px; }
        code {
            background-color: #f0f2f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "Consolas", "Monaco", monospace;
            color: #c0392b;
            font-size: 0.95em;
        }
        pre {
            background-color: #2d3436;
            color: #dfe6e9;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 0.9em;
            margin: 10px 0;
        }
        .note {
            background-color: #e8f6f3;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            margin: 20px 0;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .highlight { color: #d35400; font-weight: bold; }
    </style>
</head>
<body>

    <article>
        <h1>คู่มือติดตั้ง n8n บน Fly.io แบบประหยัดงบ (ใช้ Cron-job.org กระตุ้น)</h1>
        <p>คู่มือนี้จะสอนวิธีติดตั้ง n8n โดยใช้ Database แยกเพื่อความเสถียร และตั้งค่าให้ Server <strong>"หลับ"</strong> เมื่อไม่มีการใช้งาน เพื่อให้อยู่ในงบ Free Tier ($5/เดือน) โดยใช้ Cron-job.org เป็นตัวปลุกให้ทำงานตามเวลา</p>

        <div class="note">
            <strong>หลักการทำงาน:</strong> Server จะปิดตัวเองเมื่อไม่มีงาน และจะตื่นขึ้นมาเมื่อเราส่ง Webhook เข้าไปกระตุ้น ทำให้ไม่เปลืองชั่วโมงการทำงาน
        </div>

        <h2>1. เตรียมความพร้อม</h2>
        <pre>
mkdir my-n8n-fly
cd my-n8n-fly
flyctl auth login</pre>

        <h2>2. สร้างไฟล์ Config</h2>
        
        <h3>2.1 สร้างไฟล์ <code>Dockerfile</code></h3>
        <pre>
FROM n8nio/n8n:latest
USER root
RUN npm install -g playwright
USER node</pre>

        <h3>2.2 สร้างไฟล์ <code>fly.toml</code> (ตั้งค่า Sleep Mode)</h3>
        <p class="warning">จุดสำคัญคือการตั้งค่า <code>min_machines_running = 0</code> เพื่ออนุญาตให้เครื่องหยุดทำงานได้</p>
        <pre>
# fly.toml
app = 'ชื่อแอพของคุณ-n8n' 
primary_region = 'hkg' # แนะนำ hkg (ฮ่องกง) หรือ lax (LA)

[build]
  dockerfile = "Dockerfile"

[[mounts]]
  source = 'n8n_vol'
  destination = '/home/node/.n8n'
  auto_extend_size_threshold = 80
  auto_extend_size_increment = "1GB"
  auto_extend_size_limit = "5GB"

[http_service]
  internal_port = 5678
  force_https = true
  auto_stop_machines = 'stop'   # สั่งให้หยุดเมื่อไม่มีคนใช้
  auto_start_machines = true    # สั่งให้ตื่นเมื่อมี Request เข้ามา
  min_machines_running = 0      # อนุญาตให้ปิดเครื่องเหลือ 0 ได้
  processes = ['app']

  [http_service.concurrency]
    type = 'connections'
    hard_limit = 25
    soft_limit = 20

[[vm]]
  memory = '1024mb' 
  cpu_kind = 'shared'
  cpus = 1</pre>

        <h2>3. สร้าง Infrastructure</h2>
        <pre>
# 1. สร้าง App
flyctl apps create ชื่อแอพของคุณ-n8n --org personal

# 2. สร้าง Volume
flyctl volumes create n8n_vol --region hkg --size 1 --app ชื่อแอพของคุณ-n8n

# 3. สร้าง Database
flyctl postgres create --name ชื่อแอพของคุณ-n8n-db --region hkg --vm-size shared-cpu-1x --volume-size 1

# 4. เชื่อมต่อ Database (เพื่อเอา User/Pass)
flyctl postgres attach --app ชื่อแอพของคุณ-n8n ชื่อแอพของคุณ-n8n-db</pre>

        <h2>4. ตั้งค่า Secrets (แยกตัวแปร DB เพื่อความชัวร์)</h2>
        <p>1. รันคำสั่งเพื่อดูรหัสผ่าน: <code>flyctl ssh console --app ชื่อแอพของคุณ-n8n -C 'echo $DATABASE_URL'</code></p>
        <p>2. นำ User/Password ที่ได้ มาใส่ในคำสั่งด้านล่างนี้:</p>
        <pre>
flyctl secrets set \
  N8N_HOST='ชื่อแอพของคุณ-n8n.fly.dev' \
  N8N_PORT='5678' \
  N8N_PROTOCOL='https' \
  WEBHOOK_URL='https://ชื่อแอพของคุณ-n8n.fly.dev' \
  GENERIC_TIMEZONE='Asia/Bangkok' \
  N8N_ENCRYPTION_KEY='ใส่รหัสสุ่มยาวๆ' \
  DB_TYPE=postgresdb \
  DB_POSTGRESDB_HOST=ชื่อแอพของคุณ-n8n-db.internal \
  DB_POSTGRESDB_PORT=5432 \
  DB_POSTGRESDB_DATABASE=ชื่อแอพของคุณ-n8n \
  DB_POSTGRESDB_USER=&lt;User_ที่ได้มา&gt; \
  DB_POSTGRESDB_PASSWORD=&lt;Password_ที่ได้มา&gt; \
  --app ชื่อแอพของคุณ-n8n</pre>

        <h2>5. Deploy และเริ่มใช้งาน</h2>
        <pre>flyctl deploy --app ชื่อแอพของคุณ-n8n</pre>

        <h2>6. วิธีตั้งค่า Cron-job.org (สำคัญมาก!)</h2>
        <p>เนื่องจากเครื่องจะ "หลับ" เราจึงใช้ Node <code>Schedule Trigger</code> ใน n8n ไม่ได้ (เพราะนาฬิกาจะหยุดเดิน) เราต้องใช้วิธีนี้แทน:</p>
        
        <h3>ใน n8n:</h3>
        <ol>
            <li>สร้าง Workflow ใหม่</li>
            <li>ใช้ Node <strong>Webhook</strong> เป็นตัวเริ่ม (Start Node)</li>
            <li>ตั้ง Method เป็น <code>GET</code></li>
            <li>Copy <strong>Production URL</strong> (เช่น <code>https://.../webhook/...</code>)</li>
            <li>กด <strong>Active</strong> Workflow ไว้</li>
        </ol>

        <h3>ใน Cron-job.org:</h3>
        <ol>
            <li>สมัครสมาชิกและสร้าง Cronjob ใหม่</li>
            <li>ใส่ URL ที่ได้จาก n8n ลงไป</li>
            <li>ตั้งเวลาที่ต้องการ (เช่น ทุก 15 นาที หรือ ทุกวันเวลา 08.00 น.)</li>
            <li>บันทึก</li>
        </ol>
        
        <div class="note">
            เมื่อถึงเวลา Cron-job.org จะยิง Request มาที่ Fly.io > เครื่อง n8n จะตื่นขึ้น (ใช้เวลา 5-10 วิ) > รันงานจนเสร็จ > และกลับไปหลับเมื่อไม่มีงานต่อ ประหยัดงบได้ 100%
        </div>

    </article>

</body>
</html>
